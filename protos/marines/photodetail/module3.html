<!--[section:item]-->
<div id="gallery-of-hero-photos" class="gallery-of-hero-photos background-color-primary">
  <div class="control-nav" id="control-nav">
    <div class="container-fluid no-gutters nopad">
      <div class="row no-gutters">
        <div class="col-6 col-sm-6 col-md-6 col-lg-5">
          <a class="gallery-control-prev" id="gallery-control-prev" role="button" data-slide="prev">
            <div><span>PREVIOUS</span></div>
          </a>
        </div>
        <div class="col-md-2 col-lg-2 hide-on-mobile">
          <a href="#photo-info" role="button" class="carousel-control-down" id="carousel-control-down">
            <i class="fas fa-chevron-down"></i>
          </a>
        </div>
        <div class="col-6 col-sm-6 col-md-6 col-lg-5">
          <a class="gallery-control-next" id="gallery-control-next" role="button" data-slide="next">
            <div><span>NEXT</span></div>
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="slider">
    <div class="wrapper" id="hero-slider">
      <!-- dynamically loading -->
    </div>
  </div>
</div>

<div class="background-color-primary photo-info" id="photo-info">
  <div class="container-fluid">
    <div class="row margin-horizontal-10" id="main-photo-detail-carousel">
      <div class="offset-lg-1 col-lg-3 col-12 col-sm-12 col-md-12 main-photo-title" id="main-photo-title">
        <h4 class="photo-caption">[i:shorttitle]</h4>
        <p class="photo-sub-caption">U.S. Marine Corps photo by [i:author]/Released [i:filename]</p>
      </div>
      <div class="col-12 col-sm-12 col-md-7 hide-on-mobile">
        <div class="pager-section">
          <div class="carousel-div">
            <div class="wrapper">
              <div id="carousel-of-thumbs" class="carousel-of-thumbs slide row">
                <div class="carousel-inner w-100 mx-auto row" role="listbox" id="thumbs-slider">
                  <!-- repeated content -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-12 col-md-1 container-fluid align-self-center text-center d-md-flex ml-auto hide-on-mobile">
        <span class="dual-link carousel-dual-link" id="carousel-dual-link">
          <a class="previous" id="thumbs-carousel-prev"><span></span></a>
          <a class="next" id="thumbs-carousel-next"><span>Next</span></a>
        </span>
      </div>
    </div>
  </div>

  <div class="container-fluid background-color-primary photo-details" id="photo-details">
    <div class="row">
      <div class="col-md-12 col-11 offset-lg-1 col-lg-11">
        <p id="photo-date" class="photo-date">[i:createdon]</p>
      </div>
    </div>
    <div class="row marginRow">
      <div class="offset-lg-1 col-lg-6 col-md-12 photo-detail-data" id="photo-detail-data">
        <div class="row">
          <div class="col-12">
            <p id="photo-desc" class="photo-desc">[i:caption]</p>
          </div>
        </div>
        <div class="row download-photos">
          <div class="col-12 col-md-auto  col-sm-auto mb-3">
            <a href="[i:fullurl]" class="download-link" download="[i:fullurl]"><i class="fa fa-download"></i> DOWNLOAD</a>
          </div>
          <div class="col-12 col-md-5  col-sm-auto offset-col-md-2 mb-3">
            <a class="share-link addthis_button" addthis:url="[i:baseurl]"><i class="fas fa-info-circle"></i> SHARE</a>
            <script type="text/javascript">
              var addthis_config = {
                data_use_flash: false,
                data_use_cookies: false,
                ui_508_compliant: true
              }
            </script>
            <script type="text/javascript" src="[ig:urlprotocol]://s7.addthis.com/js/300/addthis_widget.js#pubid=[addthis:pubid]"></script>
          </div>
        </div>

        <div class="row img-public">
          <div class="col-12">
            <h4 id="public-domain">IMAGE IS PUBLIC DOMAIN</h4>
            <a id="readmore-link" class="readmore"><span>Read More</span></a>
            <p class="photo-release" id="photo-release">
              This photograph is considered public domain and has been cleared for release. If you would like to republish please give the photographer appropriate credit.
              Further, any commercial or non-commercial use of this photograph or any other DoD image must be made in compliance with guidance found at
              <a href="http://www.dimoc.mil/resources/limitations.html" target="_new">http://www.dimoc.mil/resources/limitations.html</a>,
              which pertains to intellectual property restrictions (e.g., copyright and trademark, including the use of official emblems, insignia, names and slogans), warnings
              regarding use of images of identifiable personnel, appearance of endorsement, and related matters.
            </p>
          </div>
        </div>
      </div>

      <div class="text-left offset-lg-1 col-lg-4 col-md-12 hide-on-mobile">
        <p class="photo-attribute title">CAMERA </p>
        <p class="photo-attribute value">Canon EOS 5d Mark III</p>
        <p class="photo-attribute title">LENS </p>
        <p class="photo-attribute value">EF 50mm f/2.5 Compact Macro</p>
        <p class="photo-attribute title">APERTURE</p>
        <p class="photo-attribute value">f/3.2</p>
        <p class="photo-attribute title">SHUTTERSPEED</p>
        <p class="photo-attribute value">1/400</p>
        <p class="photo-attribute title">ISO</p>
        <p class="photo-attribute value">250</p>
      </div>
      <!-- end side column -->
    </div>
  </div>
</div>

[i:hasrelated]
<div id="marines-related-news" class="container-fluid no-gutters pad0 d-flex marines-related-news">
  <div class="container-fluid align-self-center">
    <div class="row">
      <div class="text-left offset-lg-1 col-lg-3 col-md-12 col-sm-12 align-self-center">
        <h1 id="related-title">RELATED NEWS</h1>
      </div>
      <div class="col-lg-5 col-md-12 col-sm-12 align-self-center">
        <div id="in-the-news-scroll" class="carousel-of-news" data-ride="carousel" data-interval="false">
          <ul class="carousel-inner align-center" id="related-news-list">
            [i:relatedarticles]
            <li class="current">
              <a href="#">
                <span class="related-title">U.S., French complete pivotal deployment in the U.S. 5th Fleet</span>
                <span class="related-annotation">27/02/2018 Staff Sgt. Vitaliy Rusavskiy, TF 51/5 </span>
              </a>
            </li>
          </ul>
        </div>
      </div>
      <div class="col-3 col-lg-2 col-sm-12 offest-md-0 align-self-center align-right hide-on-mobile">
        <span class="dual-link">
          <a class="previous" id="related-news-prev"><span></span></a>
          <a class="next" id="related-news-next"><span>Next</span></a>
        </span>
      </div>
    </div>
  </div>
</div>
[/i:hasrelated]

[i:usePrevNextGallery]
[prevnextdetailsgalleryjs]
[/i:usePrevNextGallery]

<script type="text/javascript">
  $('#heroPane').css('display', 'none');

  $('#readmore-link').on('click', function(e) {
    $(this).toggleClass('expanded');
  });

  // $('#gallery-control-next').on('click', function(e) {
  //   if (galleryEndPage[moduleid] === totalpages[moduleid]) {
  //     if (debug) {
  //       console.log('click > load next page is at the end. Non-op');
  //     }
  //     //need to mark whatever as "can't load more"
  //     e.preventDefault();
  //     return;
  //   }
  //   if (debug) {
  //     console.log('click > load next page');
  //   }
  //   GalleryLoadNextPage();
  //   e.preventDefault();
  // });
  //
  // $('#gallery-control-prev').on('click', function(e) {
  //   if (galleryStartPage[moduleid] === 1) {
  //     if (debug) {
  //       console.log('click < load previous page is at beginning. Non-op');
  //     }
  //     //need to mark things as 'cannot request more, last page already retrieved'
  //     e.preventDefault();
  //     return;
  //   }
  //   if (debug) {
  //     console.log('click < load previous page');
  //   }
  //   GalleryLoadPrevPage();
  //   e.preventDefault();
  // });

  /* NewsSlider - requires TimeMax & TimelineMax Libraries
    to be loaded via SharedLibrary UseGSAP) or Node (via skin).
    @developer Ella Musina (emusina@omnitecinc.com)
  */
  var NewsSlider = NewsSlider || function(config) {
    var container = config.container ? document.getElementById(config.container) : null;
    var prev = config.prev ? document.getElementById(config.prev) : null;
    var next = config.next ? document.getElementById(config.next) : null;
    if (!container || !prev || !next) return;

    var slides = container.children;
    var quantity = slides.length;
    var currentSlide, currentIndex, isAnimating = false,
      currentIndex = 0;

    function observe() {
      if (prev && next) {
        prev.addEventListener('click', function(e) {
          if (!isAnimating) slideInPrev();
        }, false);
        next.addEventListener('click', function(e) {
          if (!isAnimating) slideInNext();
        }, false);
        prev.addEventListener('touch', function(e) {
          if (!isAnimating) slideInPrev();
        }, false);
        next.addEventListener('touch', function(e) {
          if (!isAnimating) slideInPrev();
        }, false);
      }
      jQuery(container).swipe({
        swipeLeft: function(event, direction, distance, duration, fingerCount, fingerData) {
          if (!isAnimating) slideInNext();
        },
        swipeRight: function(event, direction, distance, duration, fingerCount, fingerData) {
          if (!isAnimating) slideInPrev();
        }
      });
    }

    function getCurrentSlide() {
      for (var j = 0, len = slides.length; j < len; j++) {
        if (slides[j].classList.contains('current')) {
          currentIndex = j;
          currentSlide = slides[j];
          break;
        }
      }
    }

    function slideInNext() {
      isAnimating = true;
      getCurrentSlide();
      if ((currentIndex + 1) < quantity) {
        nextSlide = slides[++currentIndex];
      } else {
        currentIndex = 0;
        nextSlide = slides[currentIndex];
      }

      var timeline = new TimelineMax({
        paused: true,
        onComplete: function() {
          currentSlide.setAttribute('style', '');
          currentSlide.classList.remove('current');
          nextSlide.classList.add('current');
          currentSlide = nextSlide;
          isAnimating = false;
        }
      });

      timeline
        .set(nextSlide, {
          x: '100%',
          visibility: 'visible',
          opacity: 1
        })
        .to(currentSlide, 0.5, {
          x: '-100%',
          ease: 'cubic-bezier(0.0, 0.0, 0.2, 1)'
        }, 0.1)
        .to(nextSlide, 0.5, {
          x: '0%',
          ease: 'cubic-bezier(0.0, 0.0, 0.2, 1)'
        }, 0.1);

      timeline.play();
    }

    function slideInPrev() {
      isAnimating = true;
      getCurrentSlide();
      if ((currentIndex - 1) >= 0) {
        prevSlide = slides[--currentIndex];
      } else {
        currentIndex = quantity - 1;
        prevSlide = slides[currentIndex];
      }

      var timeline = new TimelineMax({
        paused: true,
        onComplete: function() {
          currentSlide.setAttribute('style', '');
          currentSlide.classList.remove('current');
          prevSlide.classList.add('current');
          currentSlide = prevSlide;
          isAnimating = false;
        }
      });

      timeline
        .set(prevSlide, {
          x: '-100%',
          visibility: 'visible',
          opacity: 1
        })
        .to(prevSlide, 0.5, {
          x: '0%',
          ease: 'cubic-bezier(0.0, 0.0, 0.2, 1)'
        }, 0.1)
        .to(currentSlide, 0.5, {
          x: '100%',
          ease: 'cubic-bezier(0.0, 0.0, 0.2, 1)'
        }, 0.1);

      timeline.play();
    }

    function setup() {
      observe();
    }

    setup();
  };

  /*
    GallerySlider - Slideshow of images
    @developer - Ella Musina (emusina@omnitecinc.com)
  */
  var GallerySlider = GallerySlider || function(config) {
    var element = config.id ? document.getElementById(config.id) : null;
    if (!element) return;

    var view = document.getElementById('hero-slider');
    var views = view.getElementsByClassName('item');
    if (!view || !views || views.length === 0) return;

    var carousel = document.getElementById('carousel-of-thumbs');
    var wrapper = document.getElementById('thumbs-slider');
    var thumbs = wrapper.getElementsByClassName('item');
    if (!carousel || !wrapper || !thumbs || thumbs.length === 0) return;

    var prevHero = document.getElementById('gallery-control-prev');
    var nextHero = document.getElementById('gallery-control-next');
    var prev = document.getElementById('thumbs-carousel-prev');
    var next = document.getElementById('thumbs-carousel-next');

    var isAnimating = false;
    var currentView = views[0],
      currentIndex = 0,
      currentThumb = thumbs[0];
    var autoRotate = config.autorotate || false;
    var stopRotate = config.stoprotate || false;
    var rotateDuration = config.rotateduration || 5000;
    var animateInView = config.animateinview || false;
    var jump, totalJumps;

    function getPosition() {
      for (var index = 0, len = views.length; index < len; index++) {
        if (views[index].classList.contains('current')) {
          currentIndex = index;
          currentThumb = thumbs[index];
          currentView = views[index];
          break;
        }
      }
    }

    function setCarouselWidth() {
      jump = 0;
      totalJumps = Math.ceil(thumbs.length / 4);
      TweenMax.set(wrapper, {
        x: 0,
        width: (totalJumps * 100) + '%'
      });
    }

    function slideIn(e) { // mistake
      var thumb = e.currentTarget;
      console.log('Gallery > slideIn ', thumb.index);
      if (currentIndex !== thumb.index && !isAnimating) {
        isAnimating = true;
        while (!thumb.classList.contains('item')) {
          thumb = thumb.parentNode;
        }
        if (thumb.index > currentIndex) {
          slideInFromRight(thumb);
        } else {
          slideInFromLeft(thumb);
        }
      }
    }

    function slideInFromLeft(thumb) {
      console.log('Gallery > slideInFromLeft ', thumb.index);
      thumb.classList.add('current');
      var timeline = new TimelineMax({
        paused: true,
        onStart: function() {
          thumbs[currentIndex].classList.remove('current');
        },
        onComplete: function() { // use tmp reassignments on failure
          views[currentIndex].style = '';
          currentIndex = thumb.index;
          currentView = thumb.view;
          isAnimating = false;
        }
      });
      timeline
        .addLabel('init')
        .set(thumb.view, {
          x: '-100%',
          opacity: 1,
          visibility: 'visible'
        }, 'init')
        .addLabel('move')
        .to(views[currentIndex], 0.8, {
          x: '100%',
          ease: 'Power4.easeOut'
        }, 0.1, 'move')
        .to(thumb.view, 0.8, {
          x: '0%',
          ease: 'Power4.easeOut'
        }, 0.1, 'move');
      timeline.play();
    }

    function slideInFromRight(thumb) {
      console.log('Gallery > slideInFromRight ', thumb.index);
      thumb.classList.add('current');
      var timeline = new TimelineMax({
        paused: true,
        onStart: function() {
          thumbs[currentIndex].classList.remove('current');
        },
        onComplete: function() {
          views[currentIndex].style = '';
          currentIndex = thumb.index;
          currentView = thumb.view;
          isAnimating = false;
        }
      });
      timeline
        .addLabel('init')
        .set(thumb.view, {
          x: '100%',
          opacity: 1,
          visibility: 'visible'
        }, 'init')
        .addLabel('move')
        .to(views[currentIndex], 0.8, {
          x: '-100%',
          ease: 'Power4.easeOut'
        }, 0.1, 'move')
        .to(thumb.view, 0.8, {
          x: '0%',
          ease: 'Power4.easeOut'
        }, 0.1, 'move');
      timeline.play();
    }

    function moveLeft() {
      console.log('Gallery > moveLeft');
      var prevIndex = currentIndex - 1;
      if (prevIndex <= 0) {
        prevIndex = thumbs.length - 1;
      }
      var thumb = thumbs[prevIndex];
      slideInFromLeft(thumb);
    }

    function moveRight() {
      console.log('Gallery > moveRight');
      var nextIndex = currentIndex + 1;
      if (nextIndex >= thumbs.length) {
        nextIndex = 0;
      }
      var thumb = thumbs[nextIndex];
      slideInFromRight(thumb);
    }

    var timer;

    function rotate() {
      timer = window.setInterval(function() {
        moveRight();
      }, rotateDuration);
    }

    function pause() {
      window.clearInterval(timer);
    }

    function moveThumbsRight() {
      console.log('Gallery > moveThumbsRight');
      if (jump - 1 >= 0) {
        jump--;
      } else {
        jump = totalJumps - 1;
        TweenMax.set(wrapper, {
          x: -totalJumps * 100 + '%'
        });
      }
      TweenMax.to(wrapper, 0.8, {
        x: -(jump * 100) + '%',
        ease: 'cubic-bezier(0, 0, 0, 1.1)'
      });
    }

    function moveThumbsLeft() {
      console.log('Gallery > moveThumbsLeft');
      if (jump + 1 < totalJumps) {
        jump++;
      } else {
        jump = 0;
        TweenMax.set(wrapper, {
          x: '100%'
        });
      }
      TweenMax.to(wrapper, 0.8, {
        x: -(jump * 100) + '%',
        ease: 'cubic-bezier(0, 0, 0, 1.1)'
      });
    }

    function scrollToBanner() {
      TweenMax.to(window, 0.8, {
        scrollTo: 0,
        ease: 'cubic-bezier(0.4, 0.0, 0.2, 1)'
      });
    }

    function observe() {
      console.log('Gallery > observe');
      for (var idx = 0, len = views.length; idx < len; idx++) {
        thumbs[idx].view = views[idx];
        thumbs[idx].index = idx;
        thumbs[idx].addEventListener('click', function(e) {
          e.stopPropagation();
          slideIn(e);
        }, false);
        thumbs[idx].addEventListener('touch', function(e) {
          e.stopPropagation();
          slideIn(e);
        }, false);
      }

      prev.addEventListener('click', function(e) {
        moveThumbsRight(e);
      }, false);
      prev.addEventListener('touch', function(e) {
        moveThumbsRight(e);
      }, false);
      next.addEventListener('click', function(e) {
        moveThumbsLeft(e);
      }, false);
      next.addEventListener('touch', function(e) {
        moveThumbsLeft(e);
      }, false);
      prevHero.addEventListener('click', function(e) {
        moveLeft();
      }, false);
      nextHero.addEventListener('click', function(e) {
        moveRight();
      }, false);

      if (stopRotate) {
        element.addEventListener('mouseover', function() {
          pause();
        }, false);
        element.addEventListener('mouseout', function() {
          rotate();
        }, false);
      }

      if (autoRotate) {
        window.addEventListener('resize', function() { // debouncer
          pause();
          if (timer) clearInterval(timer);
          timer = window.setTimeout(function() {
            setCarouselWidth();
            rotate();
          }, 12000);
        }, false);
        rotate();
      } else {
        window.addEventListener('resize', function() {
          window.setTimeout(function() {
            setCarouselWidth();
          }, 200);
        });
      }

      if (animateInView) { //jquery.inview plugin
        $(element).on('inview', function(event, isInView) {
          if (isInView) {
            TweenMax.to(element, 0.25, {
              opacity: 1,
              y: 0,
              ease: 'cubic-bezier(0.0, 0.0, 0.2, 1)',
              onComplete: function() {
                $(element).off('inview');
              }
            });
          }
        });

        $(carousel).on('inview', function(event, isInView) {
          if (isInView) {
            TweenMax.staggerTo(thumbs, 0.25, {
              opacity: 1,
              ease: 'cubic-bezier(0.0, 0.0, 0.2, 1)',
              onComplete: function() {
                $(carousel).off('inview');
              }
            }, 0.12);
          }
        });
      }
    }

    function loadDefaults() {
      if (currentThumb) currentThumb.classList.add('current');
      if (animateInView) { // material lib animation standards
        TweenMax.set(element, {
          opacity: 0,
          y: 30
        });
        TweenMax.set(thumbs, {
          opacity: 0
        });
      }
      TweenMax.set(views[currentIndex], {
        visibility: 'visible',
        opacity: 1
      });
    }

    function init() {
      getPosition();
      setCarouselWidth();
      loadDefaults();
      observe();
    }

    init();
  };

  /*
    Custom Animations
    @developer Ella Musina (emusina@omnitecinc.com)
  */
  function AnimateGalleryImage() {
    var isShown = false;
    var control = document.getElementById('control-nav');
    var prev = document.getElementById('gallery-control-prev');
    var next = document.getElementById('gallery-control-next');
    var down = document.getElementById('carousel-control-down');
    if (!control || !prev || !next) return;

    var timeline = new TimelineMax({
      paused: true,
      delay: 1.5
    });
    timeline
      .addLabel('show')
      .to(prev, 0.5, {
        opacity: 1,
        x: 0,
        ease: 'cubic-bezier(0.0, 0.0, 0.2, 1)'
      }, 'show')
      .to(down, 0.5, {
        opacity: 1,
        ease: 'cubic-bezier(0.0, 0.0, 0.2, 1)'
      }, 'show')
      .to(next, 0.5, {
        opacity: 1,
        x: 0,
        ease: 'cubic-bezier(0.0, 0.0, 0.2, 1)'
      }, 'show');

    $('#control-nav').on('inview', function(event, isInView) {
      if (isInView && !isShown) {
        isShown = true;
        timeline.play();
      }
    });

    if (down) {
      down.addEventListener('click', function(e) { // on desktop
        e.preventDefault();
        TweenMax.to(window, 0.5, {
          scrollTo: '#photo-info',
          ease: 'cubic-bezier(.41,.73,.47,.96)'
        });
      });
    }
  }

  function AnimateGalleryCarousel() {
    var items = [],
      isShown = false;
    var title = document.getElementById('main-photo-title');
    var imgs = document.querySelectorAll('#carousel-of-thumbs img');
    var link = document.getElementById('carousel-dual-link');
    if (imgs && imgs.length > 0) items = imgs.slice(0, 4);

    var timeline = new TimelineMax({
      paused: true,
      delay: 0.5
    });
    timeline
      .addLabel('title')
      .to(title, 0.5, {
        opacity: 1,
        y: 0,
        ease: 'cubic-bezier(0.0, 0.0, 0.2, 1)'
      }, 'title')
      .addLabel('carousel')
      .staggerTo(items, 0.5, {
        opacity: 1,
        y: 0,
        scale: 1,
        ease: 'cubic-bezier(0.0, 0.0, 0.2, 1)'
      }, 0.5, 'carousel')
      .addLabel('dual-link')
      .to(link, 0.5, {
        opacity: 1,
        y: 0,
        ease: 'cubic-bezier(0.0, 0.0, 0.2, 1)'
      }, 'dual-link');

    $('#main-photo-detail-carousel').on('inview', function(event, isInView) {
      if (isInView && !isShown) {
        isShown = true;
        timeline.play();
      }
    });
  }

  function AnimateGalleryBody() {
    var isShown = false;
    var dateline = document.getElementById('photo-date');
    var photodata = document.getElementById('photo-detail-data');
    var attrs = document.querySelectorAll('.photo-attribute');

    var timeline = new TimelineMax({
      paused: true,
      delay: 0.5
    });
    timeline
      .addLabel('details')
      .staggerTo([dateline, photodata], 0.5, {
        opacity: 1,
        y: 0,
        ease: 'cubic-bezier(0.0, 0.0, 0.2, 1)'
      }, 0.3, 'details')
      .staggerTo([attrs], 0.5, {
        opacity: 1,
        y: 0,
        ease: 'cubic-bezier(0.0, 0.0, 0.2, 1)'
      }, 0.3, 'details');

    $('#photo-details').on('inview', function(event, isInView) {
      if (isInView && !isShown) {
        isShown = true;
        timeline.play();
      }
    });
  }

  function GalleryPage() {
    window.totalGalleryImages = 0;
    window.totalGalleryImagesCounter = 0;
    var heroSlider = document.getElementById('hero-slider');
    var thumbSlider = document.getElementById('thumbs-slider');
    var currentImageId = getFileIdFromUrl();
    var gallerySlider;

    function init() {
      GalleryLoadInitialPage(); //comming from api
      observe();
      AnimateGalleryImage();
      AnimateGalleryCarousel();
      AnimateGalleryBody();
    }

    function isPortrait(w, h) {
      return w <= h;
    }

    // @use instead of sizedProperties where sizes do not exist
    function getImageToLoad(imgSizes, isThumb) {
      var sortedSizes, files, dimensions;
      if (imgSizes.length > 0) {
        dimensions = (function() {
          if (isThumb) {
            return {
              width: 240,
              height: 150
            };
          } else {
            return {
              width: dma.DeviceIsMobile() ? 480 : 1088, // or use viewport width
              height: dma.DeviceIsMobile() ? 800 : 820 // or use viewport height
            };
          }
        })();
        if (isPortrait(imgSizes[0].Width, imgSizes[0].Height)) {
          sortedSizes = imgSizes.sort(function(a, b) {
            return a.Height - b.Height;
          });
          files = sortedSizes.filter(function(item) {
            return (item.Height >= dimensions.height);
          });
        } else {
          sortedSizes = imgSizes.sort(function(a, b) {
            return a.Width - b.Width;
          });
          files = sortedSizes.filter(function(item) {
            return (item.Width >= dimensions.width);
          });
        }
        console.log('sorted:', sortedSizes);
        if (files.length > 0) {
          return files[0];
        } else {
          return sortedSizes.pop();
        }
      } else {
        return null;
      }
    }

    function getFileIdFromUrl() {
      var url = window.location.href;
      var u = new URL(url);
      var c = u.searchParams.get('igphoto');
      return c;
    }

    function loadImage(obj, img, mode, template) {
      if (obj) {
        if (img) {
          preload(img.ViewUrl, mode);
          var tmpl = template ? template : 'hero';
          var md = mode ? mode : 'next';
          var data = {
            alt: obj.AltText,
            createdon: obj.CreatedOn,
            id: obj.FileId,
            name: obj.FileName,
            location: obj.Location,
            title: obj.Title,
            description: obj.Description,
            download: img.DownloadUrl
          };
          switch (template) {
            case 'hero':
              var item = document.createElement('div');
              item.className = (currentImageId == obj.FileId) ? 'item current' : 'item';
              item.innerHTML = '<img src="' + img.ViewUrl + '" alt="' + img.AltText + '" />';
              item.data = data;
              if (mode && mode === 'next') {
                heroSlider.appendChild(item);
              } else {
                heroSlider.insertBefore(item, heroSlider.firstChild);
              }
              break;
            case 'thumb':
              var item = document.createElement('div');
              item.className = 'item col-md-3 col-sm-6 col-6 align-self-center';
              item.className += (currentImageId == obj.FileId) ? ' current' : '';
              item.innerHTML = '<img src="' + img.ViewUrl + '" alt="' + img.AltText + '" />';
              item.data = data;
              if (mode && mode === 'next') {
                thumbSlider.appendChild(item);
              } else {
                thumbSlider.insertBefore(item, thumbSlider.firstChild);
              }
              break;
          }
        }
      }
    }

    function loadHero(obj, mode) { // mobile + desktop
      var img = getImageToLoad(obj.FileProperties);
      loadImage(obj, img, mode, 'hero');
    }

    function loadThumb(obj, mode) { // only desktop
      var img = getImageToLoad(obj.FileProperties, true);
      loadImage(obj, img, mode, 'thumb');
    }

    function preload(imgURL) {
      var image = new Image();
      image.src = imgURL;
      image.onload = function() {
        document.dispatchEvent(new Event('gallery-hero-preload'));
      };
      image.onerror = function() {
        console.log('image errored out >', imgURL);
        document.dispatchEvent(new Event('gallery-hero-preload'));
      };
    }

    function loadImages(newItems, mode) {
      window.totalGalleryImages = dma.DeviceIsMobile() ? newItems.length : newItems.length * 2;
      $.each(newItems, function(index, value) { // iterate over hash, !array
        loadHero(value, mode);
        if (!dma.DeviceIsMobile()) {
          loadThumb(value, mode);
        }
      });
    }

    function observe() {
      console.log('GalleryPage > observe');
      document.addEventListener('gallery-hero-preload', function(e) {
        window.totalGalleryImagesCounter++;
        // console.log('preloaded image # ', window.totalGalleryImagesCounter);
        if (window.totalGalleryImagesCounter >= window.totalGalleryImages) {
          // console.log(window.totalGalleryImagesCounter, ' >= ', window.totalGalleryImages);
          document.dispatchEvent(new Event('gallery-heros-preload-done'));
        }
      });

      document.addEventListener('gallery-heros-preload-done', function(e) {
        console.log('setup gallery slider');
        // set up a gallery
        gallerySlider = new GallerySlider({
          id: 'gallery-of-hero-photos',
          thumbsId: 'carousel-of-thumbs',
          autorotate: false,
          stoprotate: false,
          rotateduration: 5000,
          animateinview: false
        });
      });

      document.addEventListener('gallery-load-initial-page', function(e) {
        loadImages(galleryJSON[moduleid]);
      });
      document.addEventListener('gallery-load-prev-page', function(e) {
        loadImages(galleryJSON[moduleid].slice(++batchNumber * 20, 20), 'prev');
      });
      document.addEventListener('gallery-load-next-page', function(e) {
        loadImages(galleryJSON[moduleid].slice(++batchNumber * 20, 20), 'next');
      });
      document.addEventListener('gallery-load-related', function(e) {});
    }

    init();
  }

  window.addEventListener('load', function(e) {
    GalleryPage();
  });

  document.addEventListener('DOMContentLoaded', function() {
    var newsSlider = new NewsSlider({
      container: 'related-news-list',
      prev: 'related-news-prev',
      next: 'related-news-next'
    });
  });
</script>

<!--[section:noitems]-->