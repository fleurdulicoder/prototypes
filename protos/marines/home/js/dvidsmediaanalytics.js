/*
 * DVIDSVideoAnalytics.js
 * Video analytics for the DVIDS Platform
 * v0.1.0
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.DVIDSVideoAnalytics=e()}(this,function(){"use strict";function t(t){return Array.isArray(t)}function e(t){return t&&"number"==typeof t.size&&"string"==typeof t.type&&"function"==typeof t.slice}var n=function n(i,o,r,a){if(o instanceof FormData&&(a=r,r=o,o=null),(o=o||{}).indices=o.indices||!1,r=r||new FormData,function(t){return void 0===t}(i))return r;if(function(t){return null===t}(i))r.append(a,"");else if(t(i))if(i.length)i.forEach(function(t,e){var i=a+"["+(o.indices?e:"")+"]";n(t,o,r,i)});else{var c=a+"[]";r.append(c,"")}else!function(t){return t instanceof Date}(i)?!function(t){return t===Object(t)}(i)||function(t){return e(t)&&("object"==typeof t.lastModifiedDate||"number"==typeof t.lastModified)&&"string"==typeof t.name}(i)||e(i)?r.append(a,i):Object.keys(i).forEach(function(e){var c=i[e];if(t(c))for(;e.length>2&&e.lastIndexOf("[]")===e.length-2;)e=e.substring(0,e.length-2);n(c,o,r,a?a+"["+e+"]":e)}):r.append(a,i.toISOString());return r},i={set:function(t,e,n,i){var o="",r="";if(n){var a=new Date;a.setTime(a.getTime()+60*n*1e3),o="; expires="+a.toGMTString()}i&&(r="; domain="+i),document.cookie=t+"="+escape(e)+o+r+"; path=/"},get:function(t){var e,n,i=t+"=",o=document.cookie.split(";");for(e=0;e<o.length;e++){for(n=o[e];" "===n.charAt(0);)n=n.substring(1,n.length);if(0===n.indexOf(i))return unescape(n.substring(i.length,n.length))}return null}},o={urlPrefix:"https://analytics.dvidshub.net/",visitsUrl:"/ahoy/visits",eventsUrl:"/loaded",endedUrl:"/ended",playUrl:"/play",loadedUrl:"/loaded",domain:"",cookieDomain:null,page:null,platform:"Web",useBeacon:!1,startOnReady:!0,trackVisits:!0,cookies:!0},r=window.ahoy||window.Ahoy||{};r.configure=function(t){for(var e in t)t.hasOwnProperty(e)&&(o[e]=t[e])},r.configure(r);var a,c,s,u,f=window.jQuery||window.Zepto||window.$,d=240,l=1051200,p=!1,h=[],g="undefined"!=typeof JSON&&void 0!==JSON.stringify,v=[];function y(t){return o.urlPrefix+t.name}function m(t,e,n){i.set(t,e,n,o.cookieDomain||o.domain)}function k(t){return i.get(t)}function x(t){i.set(t,"",-1)}function w(t){k("ahoy_debug")&&window.console.log(t)}function b(){for(var t;t=h.shift();)t();p=!0}function _(t){p?t():h.push(t)}function S(t,e,n){document.addEventListener(t,function(t){(function(t,e){var n=t.matches||t.matchesSelector||t.mozMatchesSelector||t.msMatchesSelector||t.oMatchesSelector||t.webkitMatchesSelector;return n?n.apply(t,[e]):(w("Unable to match"),!1)})(t.target,e)&&n(t)})}function O(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)})}function V(){o.cookies&&g&&m("ahoy_events",JSON.stringify(v),1)}function j(){var t=document.querySelector("meta[name=csrf-token]");return t&&t.content}function T(t){var e=j();e&&t.setRequestHeader("X-CSRF-Token",e)}function M(t,e,n){if(g)if(f)f.ajax({type:"POST",url:t,data:JSON.stringify(e),contentType:"application/json; charset=utf-8",dataType:"json",beforeSend:T,success:n});else{var i=new XMLHttpRequest;i.open("POST",t,!0),i.setRequestHeader("Content-Type","application/json"),i.onload=function(){200===i.status&&n()},T(i),i.send(JSON.stringify(e))}}function N(t){var e=Object.assign({},t,t.properties);return o.cookies&&(e.visit_token=t.visit_token,e.visitor_token=t.visitor_token),delete e.properties,delete e.js,delete t.visit_token,delete t.visitor_token,e}function C(t){_(function(){M(y(t),N(t),function(){for(var e=0;e<v.length;e++)if(v[e].id==t.id){v.splice(e,1);break}V()})})}function D(t){_(function(){var e,i=N(t),o=(e=document.querySelector("meta[name=csrf-param]"))&&e.content,r=j();o&&r&&(i[o]=r),i.events_json=JSON.stringify(i.events),delete i.events,window.navigator.sendBeacon(y(),n(i))})}function A(){return o.page||window.location.pathname}function I(t){return t&&t.length>0?t:null}function P(t){var e=t.target;return function(t){for(var e in t)t.hasOwnProperty(e)&&null===t[e]&&delete t[e];return t}({tag:e.tagName.toLowerCase(),id:I(e.id),class:I(e.className),page:A(),section:function(t){for(;t&&t!==document;t=t.parentNode)if(t.hasAttribute("data-section"))return t.getAttribute("data-section");return null}(e)})}function J(){if(p=!1,a=r.getVisitId(),c=r.getVisitorId(),s=k("ahoy_track"),!1===o.cookies||!1===o.trackVisits)w("Visit tracking disabled"),b();else if(a&&c&&!s)w("Active visit"),b();else if(a||m("ahoy_visit",a=O(),d),k("ahoy_visit")){w("Visit started"),c||m("ahoy_visitor",c=O(),l);var t={visit_token:a,visitor_token:c,platform:o.platform,landing_page:window.location.href,screen_width:window.screen.width,screen_height:window.screen.height,js:!0};document.referrer.length>0&&(t.referrer=document.referrer),w(t),M(o.urlPrefix+o.visitsUrl,t,function(){x("ahoy_track"),b()})}else w("Cookies disabled"),b()}r.getVisitId=r.getVisitToken=function(){return k("ahoy_visit")},r.getVisitorId=r.getVisitorToken=function(){return k("ahoy_visitor")},r.reset=function(){return x("ahoy_visit"),x("ahoy_visitor"),x("ahoy_events"),x("ahoy_track"),!0},r.debug=function(t){return!1===t?x("ahoy_debug"):m("ahoy_debug","t",525600),!0},r.track=function(t,e){var n={name:t,properties:e||{},type:"video",js:!0};return _(function(){o.cookies&&!r.getVisitId()&&J(),_(function(){w(n),(o.useBeacon||o.trackNow)&&g&&void 0!==window.navigator.sendBeacon?D(n):(v.push(n),V(),setTimeout(function(){C(n)},1e3))})}),!0},r.trackView=function(t){var e={url:window.location.href,title:document.title,page:A()};if(t)for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);r.track("$view",e)},r.trackClicks=function(){S("click","a, button, input[type=submit]",function(t){var e=t.target,n=P(t);n.text="input"==n.tag?e.value:(e.textContent||e.innerText||e.innerHTML).replace(/[\s\r\n]+/g," ").trim(),n.href=e.href,r.track("$click",n)})},r.trackSubmits=function(){S("submit","form",function(t){var e=P(t);r.track("$submit",e)})},r.trackChanges=function(){S("change","input, textarea, select",function(t){var e=P(t);r.track("$change",e)})},r.trackAll=function(){r.trackView(),r.trackClicks(),r.trackSubmits(),r.trackChanges()};try{v=JSON.parse(k("ahoy_events")||"[]")}catch(t){}for(var U=0;U<v.length;U++)C(v[U]);return r.start=function(){J(),r.start=function(){}},u=function(){o.startOnReady&&r.start()},"interactive"===document.readyState||"complete"===document.readyState?u():document.addEventListener("DOMContentLoaded",u),r});
